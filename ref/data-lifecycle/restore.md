# 整体流程

![数据恢复流程](../../assets/ref/data-lifecycle/restore-process.svg)

为了保证用户数据的可用性和保证矿工自身的权益，基于切片冗余技术 CESS 网络对于服役数据有一个完整的恢复机制。

![数据恢复流程](../../assets/ref/data-lifecycle/restore-flow.png)

# 恢复机制

对于一个文件首先会切割成规范相同的的数据段（segment），在对数据段进行切片冗余后形成的文件切片（fragment）会分别存放在不同存储节点上，根据当前的冗余规则 1.5 倍冗余，只要一个文件的任意数据段丢失或损坏的数据片数量不超过三分之一，网络便可以根据其他数据片恢复该文件。

# 矿工自检

审计未通过的矿工无法获得奖励，连续未通过的情况会被惩罚。为了保证矿工的权益，矿工可以自行输入命令，进行自检，或者由矿机在随机挑战验证失败后自行触发自检。自检将对比本地存储的全部闲置与服役数据片，对比链上元信息筛选出不符合的数据片，闲置将直接丢弃，并且发起交易删除链上对应闲置数据。服役数据片矿机会优先尝试自行恢复，如果恢复失败，将发起交易生成恢复订单。

# 恢复目标 (Restore Target)

矿工主动退出或被动退出后，需要将其当前存储的服役数据转移至其他矿工，会针对此矿工账户创建恢复目标进行公示。因为需要恢复的服役数据可能过多，所以恢复订单将不由链创建，由其他矿工自行查找恢复目标存储的服役数据，发起交易申报恢复订单。

当恢复目标的全部服役数据被转移至其他矿工节点进行存储后，恢复目标将结束公示。

# 恢复订单 (Restore Order)

恢复订单是当前网络中正在执行的全部恢复任务，有两种状态，已认领 (Claimed) 和 未认领 (Unclaimed)。由矿工自行申报，申报条件如下：

- 必须为服役数据片。
- 网络中当前不存在该订单。
- 申报目标需为当前的恢复目标或矿工自身。

当申报目标为矿工自身时，订单生成后会变更为未认领 `unclaimed`状态，等待其他矿工前来认领。当申报目标为恢复目标时，订单会直接变为已认领 `claimed` 状态，认领人为本交易调用人。

已认领的恢复订单，在有效期内，如果矿工未完成恢复任务，状态会变更为未认领，等待其他矿工重新认领。

与此同时，只有一个矿工可以认领订单并执行恢复任务。在恢复过程中，矿工将优先传输存储在恢复目标上的活动文件片段和标签。如果传输失败，它将尝试从其他矿工那里下载文件片段以构建段。

# 恢复结果上报

在完成恢复任务后，矿工必须在有效期内调用交易来报告链上的恢复结果，恢复任务才被视为完成。然后，矿工的存储能力将会增加，文件的相应元信息将会被更新。

# 文件丢失

当生成一个恢复订单时，网络将检查相应数据段的当前状态。如果其数据片有超过 1/3 正在被恢复的情况，所属文件会被标记为疑似丢失，如果该数据段正在属于恢复的数据片仍然超过 1/3，那么文件将会被标记为丢失。

当前计时任务周期固定为，三倍恢复订单执行的时间。
