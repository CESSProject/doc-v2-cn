在权益证明 (Proof of Stake) 区块链中，随机性对于公平且不可预测地分配验证者职责非常重要。计算机不擅长生成随机数，因为它们是确定性设备（相同的输入总是产生相同的输出）。人们通常在计算机上称之为随机数的（例如在游戏应用程序中），实际上是伪随机数，即它们依赖于用户或其他类型的预言机（如气象站的大气噪声、心率甚至熔岩灯）提供的足够随机的种子，从而生成一系列看似随机的数字。但是，给定相同的种子，总是会生成相同的序列。

尽管这些输入会根据时间和空间而变化，但在世界各地的特定区块链的所有节点中获得相同的结果是不可能的。如果节点获得不同的输入来构建区块，分叉就会发生。现实世界的熵不适合用作区块链随机性的种子。

目前生产环境下区块链随机性主要有两种方法：[**RANDAO**](https://github.com/randao/randao#solutions) 和[**可验证随机函数**](https://en.wikipedia.org/wiki/Verifiable_random_function) (Verifiable Random Function, 简称：VRF)。

CESS 使用的是 VRF。

# 可验证随机函数 (VRF)

可验证随机函数（VRF）是一种数学运算，它接受一些输入并生成一个随机数以及证明该随机数由提交者生成的真实性证明。任何挑战者都可以验证该证明，以确保随机数生成有效。

CESS 使用的 VRF 与 [*Ouroboros Praos*](https://eprint.iacr.org/2017/573.pdf) 中使用的大致相同。Ouroboros 随机性对于区块生产是安全的，并与 BABE 兼容良好。它们的不同之处在于，CESS 的 VRF 不依赖于中央时钟（问题变成了 - 我们应用谁的中央时钟？），而是依赖于自己过去的结果来确定现在和未来的结果，并使用时隙号作为时钟模拟器，估计时间。

# 工作原理

Slot 是长度为 6 秒的离散时间单位。每个 slot 可以包含一个区块，但也可能不包含。Slot 组成了epoch - 在 CESS 上， 600 个 slot 组成一个 epoch，这使得 epoch 的长度为 1 个小时。

在每个 slot 中，每个验证者都 “掷骰子”。他们执行一个函数 (VRF)，该函数将以下内容作为输入：

- 专门用于这些骰子掷出的密钥。
- 一个 epoch 的随机值，它是上上个 epoch（N-2）中区块的 VRF 值的哈希值，因此过去的随机性影响当前待定的随机性（N）。
- 当前 slot 号。

![VRF 解说](../../assets/concepts/blockchain-core/vrf.png)

在可验证随机函数（VRF）中，有两个输出值：**RESULT**（随机值）和 **PROOF**（随机值正确生成的证明）。

然后将 RESULT 与协议实现中定义的阈值进行比较（具体来说，在 CESS 主机内）。如果该值小于阈值，则掷出该数字的验证者是该时隙的可行区块生产候选者。验证者然后尝试创建一个区块，并将此区块连同先前获得的 PROOF 和 RESULT 一起提交到网络中。在 VRF 下，每个验证者都为自己掷出一个数字，将其与阈值进行比较，并在随机掷出的数字低于该阈值时产生一个区块。

由于这种工作方式，某些 slot 可能没有验证者作为区块生产候选人，因为所有验证者候选人都掷出了太高的数字并错过了阈值。我们在[共识机制章节](consensus.md)澄清了如何解决这个问题，并确保区块时间保持近似恒定时间。
